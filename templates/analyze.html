{% extends "base.html" %}

{% block title %}Analysis Center - ArcheryAI Pro{% endblock %}

{% block content %}
<div class="main-content">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="display-6 mb-3">
                <i class="fas fa-chart-line text-primary"></i> Analysis Center
            </h2>
            <p class="lead text-muted">
                Upload your archery video or use live camera for real-time analysis
            </p>
        </div>
    </div>

    <!-- Analysis Options -->
    <div class="row">
        <div class="col-md-6">
            <div class="feature-card">
                <div class="text-center mb-4">
                    <i class="fas fa-upload fa-3x text-primary mb-3"></i>
                    <h4>Video Upload Analysis</h4>
                    <p class="text-muted">Upload a video file for comprehensive analysis</p>
                </div>

                <!-- File Upload Form -->
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="videoFile" class="form-label">Select Video File</label>
                        <input type="file" class="form-control" id="videoFile" name="file" 
                               accept="video/*,image/*" required>
                        <div class="form-text">
                            Supported formats: MP4, AVI, MOV, MKV, WMV, JPG, PNG (Max: 100MB)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="analysisType" class="form-label">Analysis Type</label>
                        <select class="form-select" id="analysisType">
                            <option value="comprehensive">Comprehensive Analysis</option>
                            <option value="quick">Quick Assessment</option>
                            <option value="detailed">Detailed Biomechanics</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-play"></i> Start Analysis
                    </button>
                </form>

                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <small id="progressText">Uploading...</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="feature-card">
                <div class="text-center mb-4">
                    <i class="fas fa-video fa-3x text-success mb-3"></i>
                    <h4>Live Camera Analysis</h4>
                    <p class="text-muted">Real-time analysis using your camera</p>
                </div>

                <!-- Camera Controls -->
                <div class="mb-3">
                    <video id="cameraFeed" class="w-100" style="border-radius: 8px; display: none;" autoplay muted></video>
                    <canvas id="analysisCanvas" class="w-100" style="border-radius: 8px; display: none;"></canvas>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <button id="startCamera" class="btn btn-success w-100">
                            <i class="fas fa-camera"></i> Start Camera
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="stopCamera" class="btn btn-danger w-100" disabled>
                            <i class="fas fa-stop"></i> Stop Camera
                        </button>
                    </div>
                </div>

                <!-- Live Analysis Results -->
                <div id="liveResults" style="display: none;">
                    <h6>Live Analysis Results</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">Form Score</small>
                                <div id="liveFormScore" class="h5 mb-0">--</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted">Draw Angle</small>
                                <div id="liveDrawAngle" class="h5 mb-0">--°</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Live Feedback:</small>
                        <div id="liveFeedback" class="small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results Section -->
    <div id="resultsSection" class="row mt-5" style="display: none;">
        <div class="col-12">
            <div class="feature-card">
                <h4 class="mb-4">
                    <i class="fas fa-chart-bar text-primary"></i> Analysis Results
                </h4>
                
                <!-- Results Loading -->
                <div id="resultsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Processing your analysis...</p>
                    <div class="progress" style="max-width: 400px; margin: 0 auto;">
                        <div id="analysisProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Results Display -->
                <div id="resultsDisplay" style="display: none;">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Visualization -->
                            <div class="mb-4">
                                <h5>Analysis Visualization</h5>
                                <img id="analysisVisualization" class="img-fluid rounded" alt="Analysis Results">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Metrics -->
                            <div class="mb-4">
                                <h5>Performance Metrics</h5>
                                <div id="metricsContainer"></div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="d-grid gap-2">
                                <button id="downloadReport" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Download Report
                                </button>
                                <button id="viewDetailedReport" class="btn btn-outline-secondary">
                                    <i class="fas fa-external-link-alt"></i> View Detailed Report
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feedback Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Professional Feedback</h5>
                            <div id="feedbackContainer" class="alert alert-info"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let cameraStream = null;
let analysisInterval = null;

// File Upload Handling
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('videoFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    formData.append('file', file);
    
    // Show progress
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsLoading').style.display = 'block';
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentSessionId = result.session_id;
            document.getElementById('progressText').textContent = 'Analysis started...';
            
            // Start polling for results
            pollAnalysisStatus();
        } else {
            throw new Error(result.error || 'Upload failed');
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
    }
});

// Poll analysis status
async function pollAnalysisStatus() {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/status/${currentSessionId}`);
        const status = await response.json();
        
        if (status.status === 'completed') {
            // Load results
            loadAnalysisResults();
        } else if (status.status === 'failed') {
            throw new Error('Analysis failed');
        } else {
            // Update progress
            const progress = status.status === 'processing' ? 50 : 25;
            document.getElementById('analysisProgress').style.width = progress + '%';
            
            // Continue polling
            setTimeout(pollAnalysisStatus, 2000);
        }
    } catch (error) {
        console.error('Status check error:', error);
        alert('Analysis failed: ' + error.message);
    }
}

// Load analysis results
async function loadAnalysisResults() {
    try {
        const response = await fetch(`/results/${currentSessionId}`);
        const data = await response.json();
        
        if (data.success) {
            displayResults(data.results, data.metrics);
        } else {
            throw new Error(data.error || 'Failed to load results');
        }
    } catch (error) {
        console.error('Results loading error:', error);
        alert('Failed to load results: ' + error.message);
    }
}

// Display results
function displayResults(results, metrics) {
    // Hide loading, show results
    document.getElementById('resultsLoading').style.display = 'none';
    document.getElementById('resultsDisplay').style.display = 'block';
    
    // Set visualization
    document.getElementById('analysisVisualization').src = `/visualization/${currentSessionId}`;
    
    // Display metrics
    const metricsContainer = document.getElementById('metricsContainer');
    metricsContainer.innerHTML = '';
    
    // Form Score
    const scoreClass = results.form_score > 85 ? 'score-excellent' : 
                      results.form_score > 70 ? 'score-good' : 'score-needs-work';
    
    metricsContainer.innerHTML = `
        <div class="text-center mb-3">
            <div class="score-circle ${scoreClass}">
                ${Math.round(results.form_score)}%
            </div>
            <small class="text-muted">Overall Form Score</small>
        </div>
        <div class="row text-center">
            <div class="col-6 mb-2">
                <div class="p-2 bg-light rounded">
                    <small class="text-muted">Draw Angle</small>
                    <div class="fw-bold">${results.draw_angle.toFixed(1)}°</div>
                </div>
            </div>
            <div class="col-6 mb-2">
                <div class="p-2 bg-light rounded">
                    <small class="text-muted">Alignment</small>
                    <div class="fw-bold">${Math.abs(results.shoulder_alignment).toFixed(1)}°</div>
                </div>
            </div>
        </div>
    `;
    
    // Display feedback
    const feedbackContainer = document.getElementById('feedbackContainer');
    feedbackContainer.innerHTML = results.feedback.map(fb => `<p class="mb-1">• ${fb}</p>`).join('');
    
    // Setup action buttons
    document.getElementById('downloadReport').onclick = () => {
        window.open(`/report/${currentSessionId}`, '_blank');
    };
    
    document.getElementById('viewDetailedReport').onclick = () => {
        window.open(`/report/${currentSessionId}`, '_blank');
    };
}

// Camera functionality
document.getElementById('startCamera').addEventListener('click', async function() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480 } 
        });
        
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('analysisCanvas');
        
        video.srcObject = cameraStream;
        video.style.display = 'block';
        canvas.style.display = 'block';
        
        document.getElementById('startCamera').disabled = true;
        document.getElementById('stopCamera').disabled = false;
        document.getElementById('liveResults').style.display = 'block';
        
        // Start live analysis
        startLiveAnalysis();
        
    } catch (error) {
        console.error('Camera error:', error);
        alert('Camera access failed: ' + error.message);
    }
});

document.getElementById('stopCamera').addEventListener('click', function() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    if (analysisInterval) {
        clearInterval(analysisInterval);
        analysisInterval = null;
    }
    
    document.getElementById('cameraFeed').style.display = 'none';
    document.getElementById('analysisCanvas').style.display = 'none';
    document.getElementById('liveResults').style.display = 'none';
    
    document.getElementById('startCamera').disabled = false;
    document.getElementById('stopCamera').disabled = true;
});

// Live analysis
function startLiveAnalysis() {
    const video = document.getElementById('cameraFeed');
    const canvas = document.getElementById('analysisCanvas');
    const ctx = canvas.getContext('2d');
    
    analysisInterval = setInterval(async () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            try {
                const response = await fetch('/api/live-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image_data: imageData })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('liveFormScore').textContent = Math.round(result.form_score) + '%';
                    document.getElementById('liveDrawAngle').textContent = result.draw_angle.toFixed(1) + '°';
                    document.getElementById('liveFeedback').innerHTML = 
                        result.feedback.map(fb => `<div class="small">• ${fb}</div>`).join('');
                }
            } catch (error) {
                console.error('Live analysis error:', error);
            }
        }
    }, 1000); // Analyze every second
}
</script>
{% endblock %}
